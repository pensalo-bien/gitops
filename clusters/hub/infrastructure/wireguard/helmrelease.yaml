# wireguard-hub-deployment.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: wg-hub
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wg-hub-sa
  namespace: wg-hub
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wireguard-hub
  namespace: wg-hub
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wireguard-hub
  template:
    metadata:
      labels:
        app: wireguard-hub
    spec:
      serviceAccountName: wg-hub-sa
      hostNetwork: true                      # bind to host network so UDP 51820 is reachable
      hostPID: true
      containers:
      - name: wireguard
        image: ghcr.io/linuxserver/wireguard:1.0.20250521
        securityContext:
          privileged: true                   # needs CAP_NET_ADMIN, etc.
        env:
        - name: PUID
          value: "1000"
        - name: PGID
          value: "1000"
        - name: TZ
          value: "Europe/Rome"
        volumeMounts:
        - name: wg-config
          mountPath: /config                  # linuxserver image stores conf in /config
      - name: wg-manager
        image: busybox:1.36
        command: ["/bin/sh","-c","sleep 3600"] # placeholder, you can add a small manager container later
        securityContext:
          privileged: true
        volumeMounts:
        - name: wg-config
          mountPath: /etc/wireguard-management
      volumes:
      - name: wg-config
        hostPath:
          path: /etc/wireguard            # persistent store for configs and peer files
          type: DirectoryOrCreate
      restartPolicy: Always
